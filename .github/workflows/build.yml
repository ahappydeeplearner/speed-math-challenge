name: 跨平台构建

on:
  push:
    tags:
      - 'v*'  # 当推送 tag 时触发（如 v1.0.0）
  workflow_dispatch:  # 允许手动触发

jobs:
  build-macos:
    name: 构建 macOS 版本
    runs-on: macos-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pygame pyinstaller pillow
    
    - name: 构建 macOS 应用
      run: |
        python3 build_installer.py
    
    - name: 上传 macOS 安装包
      uses: actions/upload-artifact@v4
      with:
        name: 速算闯关-macOS
        path: dist/速算闯关-Installer.dmg
        retention-days: 30

  build-windows:
    name: 构建 Windows 版本
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pygame pyinstaller pillow
    
    - name: 构建 Windows 应用
      run: |
        python build_windows.py
    
    - name: 上传 Windows 安装包
      uses: actions/upload-artifact@v4
      with:
        name: SpeedMathChallenge-Windows
        path: dist/SpeedMathChallenge-Windows-Installer.zip
        retention-days: 30

  create-release:
    name: 创建发布
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: 下载所有构建产物
      uses: actions/download-artifact@v4
    
    - name: 创建 Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          速算闯关-macOS/速算闯关-Installer.dmg
          SpeedMathChallenge-Windows/SpeedMathChallenge-Windows-Installer.zip
        body: |
          ## 速算闯关 - 跨平台版本
          
          ### 下载说明
          - **macOS 用户**: 下载 `速算闯关-Installer.dmg`
          - **Windows 用户**: 下载 `SpeedMathChallenge-Windows-Installer.zip`
          
          ### 安装说明
          
          **macOS**:
          1. 打开 DMG 文件
          2. 拖动应用到"应用程序"文件夹
          3. 首次运行需要在"系统偏好设置"中授权
          
          **Windows**:
          1. 解压 ZIP 文件
          2. 右键 install.bat → 以管理员身份运行
          3. 或直接运行 速算闯关.exe（便携模式）
          
          ### 系统要求
          - macOS 10.13 或更高版本
          - Windows 7/8/10/11
          
          ### 更新内容
          请查看 CHANGELOG.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
